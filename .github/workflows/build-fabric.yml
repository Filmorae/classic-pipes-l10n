name: Build (Fabric 1.21.10)

on:
  push:
    branches:
      - "1.21.10"
      - "codex/**"
      - "fix/**"
  pull_request:
    branches:
      - "1.21.10"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-fabric:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # 关键：使用官方 setup-gradle，提供更稳的缓存/下载行为
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      # 关键：对依赖解析的网络错误做“更长超时 + 重试”
      - name: Build Fabric (retry on transient network errors)
        shell: bash
        env:
          # 关键：给 Gradle 的 HTTP 连接/读写更长时间，减少 ETIMEDOUT
          GRADLE_OPTS: >-
            -Dorg.gradle.internal.http.connectionTimeout=60000
            -Dorg.gradle.internal.http.socketTimeout=60000
            -Dorg.gradle.internal.repository.max.retries=3
            -Dorg.gradle.internal.repository.initial.backoff=1000
        run: |
          set -euo pipefail
          max_attempts=5
          attempt=1

          while true; do
            echo "Attempt $attempt/$max_attempts"
            ./gradlew --no-daemon --stacktrace :fabric:build -x test && break

            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "Gradle build failed after $max_attempts attempts."
              exit 1
            fi

            attempt=$((attempt+1))
            sleep 12
          done

      - name: Upload Fabric artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: fabric-build-libs
          path: fabric/build/libs/*.jar
