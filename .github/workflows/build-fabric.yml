name: Build (Fabric 1.21.10)

on:
  push:
    branches: ["1.21.10", "codex/**", "fix/**"]
  pull_request:
    branches: ["1.21.10"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-fabric:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 关键：修复 ./gradlew Permission denied
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 关键：优先 IPv4（减少 ENETUNREACH）
      - name: Prefer IPv4
        shell: bash
        run: |
          sudo bash -c 'echo "precedence ::ffff:0:0/96  100" >> /etc/gai.conf'
          echo "NODE_OPTIONS=--dns-result-order=ipv4first" >> "$GITHUB_ENV"

      # 关键：wrapper 校验改为“尽力而为，不阻塞构建”
      - name: Validate Gradle Wrapper (best effort)
        continue-on-error: true
        uses: gradle/wrapper-validation-action@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build Fabric (retry on transient network errors)
        shell: bash
        env:
          GRADLE_OPTS: >-
            -Dorg.gradle.internal.http.connectionTimeout=60000
            -Dorg.gradle.internal.http.socketTimeout=60000
            -Dorg.gradle.internal.repository.max.retries=3
            -Dorg.gradle.internal.repository.initial.backoff=1000
        run: |
          set -euo pipefail
          max_attempts=5
          attempt=1
          while true; do
            echo "Attempt $attempt/$max_attempts"
            ./gradlew --no-daemon --stacktrace :fabric:build -x test && break
            if [ "$attempt" -ge "$max_attempts" ]; then
              echo "Gradle build failed after $max_attempts attempts."
              exit 1
            fi
            attempt=$((attempt+1))
            sleep 12
          done

      - name: Upload Fabric artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: fabric-build-libs
          path: fabric/build/libs/*.jar
